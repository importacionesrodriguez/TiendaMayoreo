<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi Tienda Online</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Estilos existentes -->
    <style>
        /* Mantenemos los estilos existentes */
        
        /* Agregamos estilos específicos para el dropdown para asegurarnos que funcione correctamente */
        .product-flavor {
            width: 100%;
            padding: 0.75rem;
            margin-bottom: 1rem;
            border: 1px solid var(--secondary);
            border-radius: 4px;
            background-color: white;
            appearance: auto; /* Asegura que aparezca el dropdown arrow nativo */
            cursor: pointer;
        }
        
        .product-flavor option {
            padding: 0.5rem;
        }
        
        .product-flavor option:disabled {
            color: #aaa;
            font-style: italic;
        }
    </style>
</head>
<body>
    <!-- Resto del HTML como estaba -->
    
    <script>
        // Variable para almacenar los productos cargados desde Google Sheets
        let productos = [];
        
        // URL de la hoja publicada como CSV - Ya configurada con tu URL
        const GOOGLE_SHEETS_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTSfNRclhMLcT7SyOOppUPbPQtSLnZTrGlHt-kTCdKUoGVgiUODTs4SQHpmcx_bKfvDc3RcsTu28JTP/pub?output=csv';
        
        // Carrito de compras
        let carrito = [];
        
        // Elementos del DOM (mantenemos los que ya tienes)
        
        // Función para cargar los datos desde Google Sheets con mejor manejo de errores
        async function cargarDatosDesdeGoogleSheets(silencioso = false) {
            try {
                // Mostrar loader solo si no es actualización silenciosa
                if (!silencioso) {
                    loader.style.display = 'flex';
                }
                
                // Agregar un parámetro de tiempo para evitar el caché
                const timestamp = new Date().getTime();
                const url = `${GOOGLE_SHEETS_URL}&_t=${timestamp}`;
                
                console.log('Cargando datos desde:', url);
                
                // Fetch para obtener los datos CSV
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`Error HTTP: ${response.status}`);
                }
                
                const csvData = await response.text();
                console.log('Datos CSV recibidos:', csvData.substring(0, 200) + '...');
                
                // Procesamiento mejorado del CSV
                const lines = csvData.split('\n');
                if (lines.length <= 1) {
                    throw new Error('No se encontraron datos en el CSV');
                }
                
                // Obtener encabezados y validar
                const headers = lines[0].split(',').map(h => h.trim());
                console.log('Encabezados detectados:', headers);
                
                // Verificar encabezados mínimos requeridos
                const requiredHeaders = ['id', 'nombre', 'sabor', 'precio', 'disponible'];
                const missingHeaders = requiredHeaders.filter(h => 
                    !headers.some(header => header.toLowerCase() === h)
                );
                
                if (missingHeaders.length > 0) {
                    throw new Error(`Faltan encabezados requeridos: ${missingHeaders.join(', ')}`);
                }
                
                // Inicializar el array de productos
                const productosRaw = [];
                
                // Procesar cada línea del CSV (excepto la cabecera)
                for (let i = 1; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (!line) continue; // Saltar líneas vacías
                    
                    // Dividir la línea por comas, teniendo en cuenta las comillas
                    const values = parseCsvLine(line);
                    if (values.length !== headers.length) {
                        console.warn(`Línea ${i+1} tiene ${values.length} valores pero se esperaban ${headers.length}. Saltando.`);
                        continue;
                    }
                    
                    const product = {};
                    
                    // Mapear los valores a propiedades del producto
                    headers.forEach((header, index) => {
                        const value = values[index] ? values[index].trim() : '';
                        const headerLower = header.toLowerCase().trim();
                        
                        // Asignar valores según el encabezado
                        switch(headerLower) {
                            case 'id':
                                product.id = parseInt(value) || i; // Usa el índice si no hay ID
                                break;
                            case 'nombre':
                                product.nombre = value;
                                break;
                            case 'descripcion':
                                product.descripcion = value;
                                break;
                            case 'sabor':
                                product.sabor = value;
                                break;
                            case 'precio':
                                // Limpiar y convertir el precio para asegurar formato correcto
                                const precioLimpio = value.replace(/[^\d.,]/g, '').replace(',', '.');
                                product.precio = parseFloat(precioLimpio) || 0;
                                if (product.precio <= 0) {
                                    console.warn(`Precio inválido (${value}) en línea ${i+1}. Usando 0.`);
                                }
                                break;
                            case 'disponible':
                                product.disponible = value.toUpperCase() === 'Y' || value.toUpperCase() === 'YES' || value.toUpperCase() === 'SI';
                                break;
                            case 'link de foto':
                            case 'foto':
                            case 'imagen':
                                product.imagen = value;
                                break;
                            default:
                                // Para cualquier otro encabezado, almacenarlo como está
                                product[headerLower] = value;
                                break;
                        }
                    });
                    
                    // Solo agregar productos con datos mínimos
                    if (product.nombre && (product.sabor || product.id)) {
                        productosRaw.push(product);
                    } else {
                        console.warn(`Producto en línea ${i+1} no tiene nombre o identificador. Saltando.`);
                    }
                }
                
                console.log('Productos crudos cargados:', productosRaw.length);
                
                // Procesar los productos para agruparlos por nombre
                const productosMap = new Map();
                
                productosRaw.forEach(producto => {
                    // Extraer el nombre base (antes de cualquier guión o separador)
                    const nombreBase = producto.nombre.split('-')[0].trim();
                    
                    if (!productosMap.has(nombreBase)) {
                        // Si es un nuevo producto, inicializar con sus variaciones
                        productosMap.set(nombreBase, {
                            id: producto.id,
                            nombre: nombreBase,
                            descripcion: producto.descripcion || '',
                            imagen: producto.imagen || '',
                            variaciones: []
                        });
                    }
                    
                    // Añadir esta variación con verificación de datos
                    if (producto.sabor) {
                        productosMap.get(nombreBase).variaciones.push({
                            nombre: producto.sabor || `Variación ${productosMap.get(nombreBase).variaciones.length + 1}`,
                            precio: producto.precio || 0,
                            precioProt: protegerPrecio(producto.precio || 0, producto.id || 1),
                            disponible: producto.disponible
                        });
                    }
                });
                
                // Convertir el Map a un array de productos
                productos = Array.from(productosMap.values());
                console.log('Productos procesados:', productos.length);
                console.log('Primer producto:', productos[0]);
                
                // Verificar si hay productos con variaciones
                const sinVariaciones = productos.filter(p => !p.variaciones || p.variaciones.length === 0);
                if (sinVariaciones.length > 0) {
                    console.warn(`${sinVariaciones.length} productos sin variaciones:`, sinVariaciones.map(p => p.nombre));
                }
                
                // Cargar los productos en la interfaz
                cargarProductos();
                
                // Ocultar loader
                if (!silencioso) {
                    loader.style.display = 'none';
                }
            } catch (error) {
                console.error('Error al cargar datos desde Google Sheets:', error);
                
                // Mostrar error solo si no es actualización silenciosa
                if (!silencioso) {
                    loader.style.display = 'none';
                    productosContainer.innerHTML = `
                        <div style="text-align: center; padding: 2rem;">
                            <p>Error al cargar los productos: ${error.message}</p>
                            <button id="reload-btn" style="padding: 0.75rem 1.5rem; margin-top: 1rem; background-color: var(--primary); color: white; border: none; border-radius: 4px; cursor: pointer;">
                                Reintentar
                            </button>
                        </div>
                    `;
                    
                    // Agregar evento para recargar
                    document.getElementById('reload-btn').addEventListener('click', () => {
                        cargarDatosDesdeGoogleSheets();
                    });
                }
            }
        }
        
        // Función auxiliar para parsear líneas CSV correctamente
        function parseCsvLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            
            result.push(current); // Añadir el último valor
            return result;
        }
        
        // Cargar productos - Versión mejorada para debugging
        function cargarProductos() {
            productosContainer.innerHTML = '';
            
            if (!productos || productos.length === 0) {
                productosContainer.innerHTML = '<p style="text-align: center; padding: 2rem;">No hay productos disponibles en este momento.</p>';
                return;
            }
            
            console.log(`Cargando ${productos.length} productos en la interfaz`);
            
            productos.forEach((producto, productoIndex) => {
                // Verificar si el producto tiene variaciones
                if (!producto.variaciones || producto.variaciones.length === 0) {
                    console.warn(`Producto ${producto.nombre} no tiene variaciones. Saltando.`);
                    return;
                }
                
                const productCard = document.createElement('div');
                productCard.className = 'product-card';
                
                // Filtrar variaciones disponibles (solo las que tienen Y)
                const variacionesDisponibles = producto.variaciones.filter(variacion => variacion.disponible);
                const hayDisponibles = variacionesDisponibles.length > 0;
                
                console.log(`Producto ${producto.nombre}: ${variacionesDisponibles.length} variaciones disponibles`);
                
                // Procesar URL de imagen desde Google Photos
                let imagenUrl = 'https://via.placeholder.com/300';
                
                if (producto.imagen && producto.imagen.trim() !== '') {
                    // Si es una URL de Google Photos, asegurarse de que sea una URL directa a la imagen
                    if (producto.imagen.includes('photos.google.com') || producto.imagen.includes('photos.app.goo.gl')) {
                        // Algunas URLs de Google Photos necesitan parámetros especiales para mostrar la imagen directamente
                        if (!producto.imagen.includes('=w')) {
                            imagenUrl = producto.imagen + '=w800-h600';
                        } else {
                            imagenUrl = producto.imagen;
                        }
                    } else {
                        // Si no es de Google Photos, usar la URL tal cual
                        imagenUrl = producto.imagen;
                    }
                }
                
                // Construir HTML para el dropdown con console.log para debugging
                const opcionesHTML = producto.variaciones.map((variacion, index) => {
                    // Verificar si la variación es válida
                    if (!variacion.nombre || variacion.nombre.trim() === '') {
                        console.warn(`Variación sin nombre en producto ${producto.nombre}. Saltando.`);
                        return '';
                    }
                    
                    const precioFormateado = variacion.precio.toFixed(2);
                    return `
                        <option value="${index}" ${!variacion.disponible ? 'disabled' : ''}>
                            ${variacion.nombre} - $${precioFormateado} ${!variacion.disponible ? '(No disponible)' : ''}
                        </option>
                    `;
                }).join('');
                
                // Construir HTML completo del producto
                productCard.innerHTML = `
                    <img src="${imagenUrl}" alt="${producto.nombre}" class="product-image">
                    <div class="product-info">
                        <h3 class="product-title">${producto.nombre}</h3>
                        <p class="product-description">${producto.descripcion || ''}</p>
                        <select class="product-flavor" id="product-flavor-${productoIndex}" ${!hayDisponibles ? 'disabled' : ''}>
                            <option value="">Selecciona un sabor</option>
                            ${opcionesHTML}
                        </select>
                        <button class="add-to-cart" id="add-to-cart-${productoIndex}" data-id="${producto.id}" ${!hayDisponibles ? 'disabled' : ''}>
                            ${hayDisponibles ? 'Agregar al Carrito' : 'No Disponible'}
                        </button>
                    </div>
                `;
                
                productosContainer.appendChild(productCard);
                
                // Agregar event listeners después de que el elemento está en el DOM
                const addToCartBtn = document.getElementById(`add-to-cart-${productoIndex}`);
                const flavorSelect = document.getElementById(`product-flavor-${productoIndex}`);
                
                if (addToCartBtn && flavorSelect) {
                    console.log(`Configurando eventos para producto ${productoIndex}: ${producto.nombre}`);
                    
                    // Verificar que el select funcione correctamente
                    console.log(`Select para ${producto.nombre}:`, flavorSelect);
                    console.log(`Opciones en el select: ${flavorSelect.options.length}`);
                    
                    addToCartBtn.addEventListener('click', () => {
                        const variacionIndex = flavorSelect.value;
                        
                        console.log(`Click en Agregar al Carrito para ${producto.nombre}`);
                        console.log(`Valor seleccionado: "${variacionIndex}"`);
                        
                        if (!variacionIndex) {
                            alert('Por favor selecciona un sabor');
                            return;
                        }
                        
                        const variacionSeleccionada = producto.variaciones[variacionIndex];
                        console.log(`Variación seleccionada:`, variacionSeleccionada);
                        
                        // Almacenar el precio original protegido antes de agregar al carrito
                        const precioOriginal = variacionSeleccionada.precio;
                        const precioProt = variacionSeleccionada.precioProt;
                        
                        agregarAlCarrito(producto, variacionSeleccionada);
                    });
                } else {
                    console.error(`No se encontraron los elementos para producto ${productoIndex}`);
                }
            });
        }

        // El resto de las funciones se mantiene igual
        
        // Inicializar actualización automática
        function iniciarActualizacionAutomatica() {
            // Primera carga de datos
            cargarDatosDesdeGoogleSheets();
            
            // Configurar actualización periódica
            const TIEMPO_ACTUALIZACION = 5 * 60 * 1000; // 5 minutos
            setInterval(() => {
                console.log('Actualizando datos automáticamente...');
                cargarDatosDesdeGoogleSheets(true);
            }, TIEMPO_ACTUALIZACION);
        }
        
        // Reemplazar el evento DOMContentLoaded
        window.addEventListener('DOMContentLoaded', () => {
            // Protección básica contra manipulaciones...
            
            // Iniciar con actualización automática
            iniciarActualizacionAutomatica();
            actualizarCarrito();
        });
    </script>
</body>
</html>
