<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi Tienda Online</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Arial', sans-serif;
        }
        
        body {
            background-color: #f5f5f5;
            color: #333;
        }
        
        header {
            background-color: #4285f4;
            color: white;
            padding: 20px 0;
            text-align: center;
        }
        
        .container {
            width: 90%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .products {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin: 20px 0;
            width: 100%;
        }
        
        .product-card {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            padding: 15px;
            transition: transform 0.3s ease;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        
        .product-card:hover {
            transform: translateY(-5px);
        }
        
        .product-image {
            width: 100%;
            height: 0;
            padding-bottom: 100%; /* Esto crea un cuadrado perfecto */
            position: relative;
            overflow: hidden;
            border-radius: 5px;
        }
        
        .product-image img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .product-info {
            margin-top: 15px;
        }
        
        .product-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .product-description {
            font-size: 14px;
            color: #666;
            margin-bottom: 10px;
        }
        
        .flavor-select {
            padding: 8px;
            width: 100%;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .price {
            font-weight: bold;
            color: #4285f4;
            margin-bottom: 10px;
        }
        
        .stock {
            font-size: 12px;
            color: #888;
            margin-bottom: 10px;
        }
        
        .add-to-cart {
            background-color: #4285f4;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            width: 100%;
            transition: background-color 0.3s ease;
        }
        
        .add-to-cart:hover {
            background-color: #3367d6;
        }
        
        .cart-section {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            padding: 15px;
            margin-top: 20px;
        }
        
        .cart-title {
            font-size: 20px;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .cart-items {
            max-height: 300px;
            overflow-y: auto;
        }
        
        .cart-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .cart-item-name {
            flex: 2;
        }
        
        .cart-item-price, .cart-item-quantity {
            flex: 1;
            text-align: center;
        }
        
        .cart-item-remove {
            background-color: #ff4444;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .cart-total {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 2px solid #eee;
            font-weight: bold;
        }
        
        .checkout-form {
            margin-top: 20px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        .form-group input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .checkout-button {
            background-color: #34a853;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            width: 100%;
            font-size: 16px;
            transition: background-color 0.3s ease;
        }
        
        .checkout-button:hover {
            background-color: #2d8e47;
        }
        
        .hidden {
            display: none;
        }
        
        .error {
            color: #ff4444;
            font-size: 14px;
            margin-top: 5px;
        }
        
        footer {
            background-color: #333;
            color: white;
            text-align: center;
            padding: 15px 0;
            margin-top: 30px;
        }
        
        @media (max-width: 768px) {
            .products {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <header>
        <h1>Mi Tienda Online</h1>
    </header>
    
    <div class="container">
        <div class="products" id="products-container">
            <!-- Los productos se cargarán dinámicamente desde Google Sheets -->
        </div>
        
        <div class="cart-section">
            <h2 class="cart-title">Carrito de Compras</h2>
            <div class="cart-items" id="cart-items">
                <!-- Los items del carrito se mostrarán aquí -->
                <div class="cart-item empty-cart">El carrito está vacío</div>
            </div>
            <div class="cart-total">
                <span>Total:</span>
                <span id="cart-total-amount">$0.00</span>
            </div>
            
            <div class="checkout-form" id="checkout-form">
                <h3>Información de Contacto</h3>
                <div class="form-group">
                    <label for="customer-name">Nombre Completo*</label>
                    <input type="text" id="customer-name" placeholder="Tu nombre completo" required>
                    <div class="error" id="name-error"></div>
                </div>
                <div class="form-group">
                    <label for="customer-phone">Número de Teléfono*</label>
                    <input type="tel" id="customer-phone" placeholder="Tu número de teléfono" required>
                    <div class="error" id="phone-error"></div>
                </div>
                <button type="button" class="checkout-button" id="checkout-button">Finalizar Compra</button>
            </div>
        </div>
    </div>
    
    <footer>
        <p>&copy; 2025 Mi Tienda Online. Todos los derechos reservados.</p>
    </footer>
    
    <script>
        // Configuración de la API de Google Apps Script
        const APPS_SCRIPT_URL = 'TU_URL_DEL_SCRIPT_AQUI';
        const SECURITY_KEY = 'TU_CLAVE_DE_SEGURIDAD'; // Debe coincidir con la del script
        
        // URLs de las imágenes en Google Photos (reemplaza con tus URLs)
        const imgUrls = {
            'producto1_sabor1': '/api/placeholder/300/300',
            'producto1_sabor2': '/api/placeholder/300/300',
            'producto1_sabor3': '/api/placeholder/300/300',
            'producto2_sabor1': '/api/placeholder/300/300',
            'producto2_sabor2': '/api/placeholder/300/300',
            'producto2_sabor3': '/api/placeholder/300/300'
        };
        
        // Estado del carrito
        let cart = [];
        let products = [];
        
        // Función para cargar productos desde Google Apps Script
        async function loadProducts() {
            try {
                // URL para obtener productos
                const url = `${APPS_SCRIPT_URL}?action=getProducts`;
                
                // En producción, descomenta este código para cargar datos reales
                /*
                const response = await fetch(url);
                const result = await response.json();
                
                if (result.status === "success" && result.data) {
                    // Procesar los datos...
                */
                
                // Datos de ejemplo para desarrollo
                const mockData = [
                    [1, "Producto 1", "Descripción del producto 1", "Sabor 1A", 100, 10, "producto1_sabor1"],
                    [2, "Producto 1", "Descripción del producto 1", "Sabor 1B", 110, 5, "producto1_sabor2"],
                    [3, "Producto 1", "Descripción del producto 1", "Sabor 1C", 120, 8, "producto1_sabor3"],
                    [4, "Producto 2", "Descripción del producto 2", "Sabor 2A", 150, 15, "producto2_sabor1"],
                    [5, "Producto 2", "Descripción del producto 2", "Sabor 2B", 160, 12, "producto2_sabor2"],
                    [6, "Producto 2", "Descripción del producto 2", "Sabor 2C", 170, 7, "producto2_sabor3"]
                ];
                
                // Usar los datos (ya sea de la API o los de ejemplo)
                const rows = mockData; // Cambia esto por result.data cuando uses la API real
                
                if (rows && rows.length > 0) {
                    // Crear un objeto temporal para agrupar los datos por producto
                    const productsMap = {};
                    
                    // Procesar cada fila
                    rows.forEach(row => {
                        const id = parseInt(row[0]);
                        const productName = row[1];
                        const description = row[2];
                        const flavor = row[3];
                        const price = parseFloat(row[4]);
                        const stock = parseInt(row[5]);
                        const imageKey = row[6];
                        
                        // Si el producto no existe en el mapa, crearlo
                        if (!productsMap[productName]) {
                            productsMap[productName] = {
                                id: id,
                                name: productName,
                                description: description,
                                flavors: [],
                                imageKey: imageKey.split('_')[0] // La parte antes del underscore
                            };
                        }
                        
                        // Añadir el sabor al producto
                        productsMap[productName].flavors.push({
                            id: id, // Guardamos el ID original de la fila
                            name: flavor,
                            stock: stock,
                            price: price,
                            imageKey: imageKey
                        });
                    });
                    
                    // Convertir el mapa en array
                    products = Object.values(productsMap);
                    
                    // Mostrar los productos
                    displayProducts();
                }
            } catch (error) {
                console.error('Error al cargar productos:', error);
            }
        }
        
        // Función para mostrar productos en la página
        function displayProducts() {
            const productsContainer = document.getElementById('products-container');
            productsContainer.innerHTML = '';
            
            products.forEach(product => {
                const productCard = document.createElement('div');
                productCard.className = 'product-card';
                
                // Selecciona la imagen para el primer sabor como predeterminada
                let imageUrl = imgUrls[`${product.imageKey}_sabor1`] || '/api/placeholder/300/200';
                
                // Construye el selector de sabores
                let flavorOptions = '';
                product.flavors.forEach((flavor, index) => {
                    flavorOptions += `<option value="${index}" ${flavor.stock <= 0 ? 'disabled' : ''}>${flavor.name} - $${flavor.price.toFixed(2)} ${flavor.stock <= 0 ? '(Agotado)' : ''}</option>`;
                });
                
                productCard.innerHTML = `
                    <div class="product-image">
                    <img src="${imageUrl}" alt="${product.name}">
                </div>
                    <div class="product-info">
                        <h3 class="product-title">${product.name}</h3>
                        <p class="product-description">${product.description}</p>
                        <select class="flavor-select" data-product-id="${product.id}">
                            ${flavorOptions}
                        </select>
                        <p class="price">$${product.flavors[0].price.toFixed(2)}</p>
                        <p class="stock">Disponibles: ${product.flavors[0].stock}</p>
                        <button class="add-to-cart" data-product-id="${product.id}">Añadir al Carrito</button>
                    </div>
                `;
                
                productsContainer.appendChild(productCard);
                
                // Añadir evento para cambiar el precio y stock al cambiar el sabor
                const flavorSelect = productCard.querySelector('.flavor-select');
                flavorSelect.addEventListener('change', function(e) {
                    const flavorIndex = parseInt(e.target.value);
                    const productId = parseInt(e.target.getAttribute('data-product-id'));
                    const product = products.find(p => p.id === productId);
                    const flavor = product.flavors[flavorIndex];
                    
                    // Actualizar precio y stock
                    productCard.querySelector('.price').textContent = `$${flavor.price.toFixed(2)}`;
                    productCard.querySelector('.stock').textContent = `Disponibles: ${flavor.stock}`;
                    
                    // Actualizar imagen según el imageKey del sabor
                    const imageUrl = imgUrls[flavor.imageKey] || '/api/placeholder/300/300';
                    productCard.querySelector('.product-image img').src = imageUrl;
                });
                
                // Añadir evento para añadir al carrito
                const addToCartBtn = productCard.querySelector('.add-to-cart');
                addToCartBtn.addEventListener('click', function(e) {
                    const productId = parseInt(e.target.getAttribute('data-product-id'));
                    const product = products.find(p => p.id === productId);
                    const flavorSelect = productCard.querySelector('.flavor-select');
                    const flavorIndex = parseInt(flavorSelect.value);
                    const selectedFlavor = product.flavors[flavorIndex];
                    
                    if (selectedFlavor.stock > 0) {
                        addToCart(product, selectedFlavor, flavorIndex);
                    } else {
                        alert('Lo sentimos, este sabor está agotado');
                    }
                });
            });
        }
        
        // Función para añadir productos al carrito
        function addToCart(product, flavor, flavorIndex) {
            // Verificar si ya existe este producto+sabor en el carrito
            const existingItemIndex = cart.findIndex(item => 
                item.productId === product.id && item.flavorName === flavor.name
            );
            
            if (existingItemIndex >= 0) {
                // Si ya existe, incrementar la cantidad si hay stock suficiente
                if (cart[existingItemIndex].quantity < flavor.stock) {
                    cart[existingItemIndex].quantity++;
                } else {
                    alert('No hay más unidades disponibles de este sabor');
                    return;
                }
            } else {
                // Si no existe, añadir nuevo item al carrito
                cart.push({
                    productId: product.id,
                    productName: product.name,
                    flavorName: flavor.name,
                    flavorIndex: flavorIndex,
                    price: flavor.price, // Precio obtenido del servidor, no modificable por el cliente
                    quantity: 1
                });
            }
            
            // Actualizar la visualización del carrito
            updateCartDisplay();
        }
        
        // Función para actualizar la visualización del carrito
        function updateCartDisplay() {
            const cartItemsContainer = document.getElementById('cart-items');
            cartItemsContainer.innerHTML = '';
            
            if (cart.length === 0) {
                cartItemsContainer.innerHTML = '<div class="cart-item empty-cart">El carrito está vacío</div>';
                return;
            }
            
            let total = 0;
            
            cart.forEach((item, index) => {
                const cartItem = document.createElement('div');
                cartItem.className = 'cart-item';
                
                const itemTotal = item.price * item.quantity;
                total += itemTotal;
                
                cartItem.innerHTML = `
                    <div class="cart-item-name">${item.productName} (${item.flavorName})</div>
                    <div class="cart-item-price">$${item.price.toFixed(2)}</div>
                    <div class="cart-item-quantity">${item.quantity}</div>
                    <button class="cart-item-remove" data-index="${index}">Eliminar</button>
                `;
                
                cartItemsContainer.appendChild(cartItem);
                
                // Añadir evento para eliminar del carrito
                const removeBtn = cartItem.querySelector('.cart-item-remove');
                removeBtn.addEventListener('click', function(e) {
                    const index = parseInt(e.target.getAttribute('data-index'));
                    removeFromCart(index);
                });
            });
            
            document.getElementById('cart-total-amount').textContent = `$${total.toFixed(2)}`;
        }
        
        // Función para eliminar un producto del carrito
        function removeFromCart(index) {
            cart.splice(index, 1);
            updateCartDisplay();
        }
        
        // Función para validar el formulario de checkout
        function validateCheckoutForm() {
            let isValid = true;
            
            // Validar nombre
            const nameInput = document.getElementById('customer-name');
            const nameError = document.getElementById('name-error');
            if (!nameInput.value.trim()) {
                nameError.textContent = 'Por favor ingresa tu nombre';
                isValid = false;
            } else {
                nameError.textContent = '';
            }
            
            // Validar teléfono
            const phoneInput = document.getElementById('customer-phone');
            const phoneError = document.getElementById('phone-error');
            if (!phoneInput.value.trim()) {
                phoneError.textContent = 'Por favor ingresa tu número de teléfono';
                isValid = false;
            } else {
                phoneError.textContent = '';
            }
            
            // La validación de dirección se ha eliminado
            
            return isValid;
        }
        
        // Función para enviar el pedido
        async function submitOrder() {
            if (cart.length === 0) {
                alert('No hay productos en el carrito');
                return;
            }
            
            if (!validateCheckoutForm()) {
                return;
            }
            
            // Recopilar datos del formulario
            const customerData = {
                name: document.getElementById('customer-name').value,
                phone: document.getElementById('customer-phone').value
            };
            
            // Preparar los datos para enviar al servidor
            const orderItems = cart.map(item => ({
                productId: item.productId,
                flavorName: item.flavorName,
                quantity: item.quantity,
                price: item.price // Para verificación en el servidor
            }));
            
            try {
                // URL para actualizar stock
                const url = `${APPS_SCRIPT_URL}?action=updateStock&key=${SECURITY_KEY}`;
                
                // En producción, descomenta este código para actualizar stock real
                /*
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `items=${encodeURIComponent(JSON.stringify(orderItems))}`
                });
                
                const result = await response.json();
                
                if (result.status !== "success") {
                    throw new Error(result.message || "Error al actualizar stock");
                }
                */
                
                // Simulación de actualización de stock (para desarrollo)
                console.log("Simulando actualización de stock con estos items:", orderItems);
                
                // Actualizar stock local (simulado)
                cart.forEach(item => {
                    const product = products.find(p => p.id === item.productId);
                    const flavor = product.flavors.find(f => f.name === item.flavorName);
                    flavor.stock -= item.quantity;
                });
                
                // Enviar WhatsApp con detalles del pedido
                sendWhatsAppMessage(customerData, cart);
                
                // Mostrar mensaje de éxito y limpiar carrito
                alert(`¡Gracias por tu compra, ${customerData.name}! Te contactaremos pronto al ${customerData.phone}.`);
                cart = [];
                updateCartDisplay();
                displayProducts(); // Actualizar la visualización de productos con el nuevo stock
                
                // Limpiar formulario
                document.getElementById('customer-name').value = '';
                document.getElementById('customer-phone').value = '';
                
            } catch (error) {
                console.error('Error al procesar el pedido:', error);
                alert('Error al procesar el pedido: ' + error.message);
            }
        }
        
        // Función para enviar mensaje de WhatsApp
        function sendWhatsAppMessage(customerData, cartItems) {
            // Número de WhatsApp donde recibirás los pedidos (formato internacional sin '+')
            const whatsappNumber = '34XXXXXXXXX'; // Reemplaza con tu número
            
            // Calcular el total del pedido
            let total = 0;
            cartItems.forEach(item => {
                total += item.price * item.quantity;
            });
            
            // Construir el mensaje con los detalles del pedido
            let message = `🛒 *NUEVO PEDIDO* 🛒\n\n`;
            message += `*Cliente:* ${customerData.name}\n`;
            message += `*Teléfono:* ${customerData.phone}\n\n`;
            message += `*PRODUCTOS:*\n`;
            
            cartItems.forEach(item => {
                const subtotal = item.price * item.quantity;
                message += `- ${item.quantity}x ${item.productName} (${item.flavorName}): ${item.price.toFixed(2)} = ${subtotal.toFixed(2)}\n`;
            });
            
            message += `\n*TOTAL: ${total.toFixed(2)}*`;
            
            // Codificar el mensaje para URL
            const encodedMessage = encodeURIComponent(message);
            
            // Crear URL de WhatsApp
            const whatsappUrl = `https://wa.me/${whatsappNumber}?text=${encodedMessage}`;
            
            // Abrir WhatsApp en una nueva ventana
            window.open(whatsappUrl, '_blank');
        }
        
        // Agregar evento al botón de checkout
        document.getElementById('checkout-button').addEventListener('click', submitOrder);
        
        // Cargar productos al iniciar la página
        window.addEventListener('DOMContentLoaded', loadProducts);
    </script>
</body>
</html>